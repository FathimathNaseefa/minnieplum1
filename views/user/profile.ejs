<%- include("../../views/partials/user/header") %>
<style>
 
 .main {
   padding: 30px 0;
 }
/* Increase the width of the table container */
.card-bod {
  width: 127%; 
  border: 0.5px solid #e7dada; 
  
}

.table-responsive {
  width: 100%; /* Adjust as needed */
  overflow-x: auto; 
}

 .dashboard-menu {
   background-color: #e4a2b0;
   border-radius: 10px;
   padding: 15px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
 }
 


 .dashboard-menu .nav-link {
 font-weight: bold;
 color: #b8074b;
 box-shadow: 0 4px 10px #b8074b, 0 4px 20px #d693ad;
 transition: box-shadow 0.3s ease;
}


.dashboard-menu .nav-link:hover {
 color: #531bac;
 box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
}


 .card {
   border-radius: 10px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
   margin-bottom: 20px;
 }
 .card1 {
  border-radius: 10px;
 }
 .card-body {
  background-color: #e4a2b0;
  
 }


 .card-header {
   background-color: #960642;
   color: white;
   border-radius: 10px 10px 0 0;
 }
 .card-heade {
   background-color: #960642;
   color: white;
   border-radius: 10px 10px 0 0;
   width: 127%;
 }


 .btn-success {
   background-color: #0e66d8;
   border-color: #6bb87d;
 }


 .btn-success:hover {
   background-color: #506955;
 }


 .form-group {
   margin-bottom: 15px;
 }


 .required {
   color: red;
 }


  @media (max-width: 768px) {
   .dashboard-menu {
     padding: 10px;
   }


   .card {
     margin-bottom: 15px;
   }
 }
 .page-header.breadcrumb-wrap {
 background-color: #eee2e9;
 padding: 15px 0;
}

.breadcrumb {
    display: flex;
    align-items: center;
    justify-content: start;
    list-style: none;
    padding: 10px 20px;
    margin: 0;
    background-color: #f7c8da;
    border-radius: 5px; 
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
    font-size: 0.9rem;
}

.breadcrumb-item {
    color: #6c757d; 
    margin-right: 10px; 
    font-weight: 500; 
}

.breadcrumb-item a {
    text-decoration: none;
    color: #007bff; /* Blue for links */
    transition: color 0.2s ease-in-out;
}

.breadcrumb-item a:hover {
    color: #0056b3; /* Darker blue on hover */
}

.breadcrumb-item + .breadcrumb-item::before {
    content: '>'; 
    margin-right: 10px;
    color: #6c757d; /* Gray for the separator */
}

.breadcrumb-item.active {
    color: #495057; 
    font-weight: bold;
    pointer-events: none; 
}
table th{
  text-align: center;
}
</style>


<main class="main">
  <section class="breadcrumb-section">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Profile</li>
        </ol>
    </nav>
</section><br><br>

  <section class="pt-10 pb-10">
    <div class="container">
      <div class="row">
        <div class="col-lg-12 m-auto">
          <div class="row">
            <!-- Dashboard Menu -->
            <div class="col-md-3">
              <div class="dashboard-menu">
                <ul class="nav flex-column" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                      <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false">
                      <i class="fi-rs-marker mr-10"></i>My Address
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                      <i class="fi-rs-shopping-bag mr-10"></i>Orders
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="wallet-history-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="wallet-history" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="referal-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="referal" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/logout">
                      <i class="fi-rs-sign-out mr-10"></i>Logout
                    </a>
                  </li>
                </ul>
              </div>
            </div>

            
<!-- Dashboard Content -->
<div class="col-md-8">
  <div class="tab-content dashboard-content">
    <!-- Dashboard Tab -->
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
      <div class="card card-green">
        <div class="card-header">
          <h5 class="mb-0 text-center">User Profile</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4 text-middle">
              <strong>Name:</strong>
            </div>
            <div class="col-md-4 text-left">
              <p><%= user.name %></p>
            </div>
            <div class="col-md-4 text-right">
              <a href="/change-name" class="btn btn-sm btn-success">Edit</a>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 text-left">
              <strong>Phone:</strong>
            </div>
            <div class="col-md-4 text-left">
              <p><%= user.phone %></p>
            </div>
            <div class="col-md-4 text-right">
              <a href="/change-phone" class="btn btn-sm btn-success">Edit</a>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 text-left">
              <strong>Email:</strong>
            </div>
            <div class="col-md-4 text-left">
              <p><%= user.email %></p>
            </div>
            <div class="col-md-4 text-right">
              <a href="/change-email" class="btn btn-sm btn-success">Edit</a>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 text-left">
              <strong>Password:</strong>
            </div>
            <div class="col-md-4 text-left">
              <p>**********</p> <!-- Masking password for security -->
            </div>
            <div class="col-md-4 text-right">
              <a href="/change-password" class="btn btn-sm btn-success">Edit</a>
            </div>
          </div>

        </div>
      </div>
    </div>
  




                <!-- Address Tab -->
                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                  <div class="row">
                    <% if (userAddresses.length > 0) { %>
                      <% userAddresses.forEach((address) => { %>
                        <div class="col-lg-6">
                          <div class="card mb-3">
                            <div class="card-header">
                              <h5 class="mb-0"><%= address.isDefault ? "Default Address" : "Address" %></h5>
                            </div>
                            <div class="card-body">
                              <address>
                                <strong><%= address.name %></strong><br/>
                                <%= address.addressLine1 %><br/>
                                <% if (address.addressLine2) { %> <%= address.addressLine2 %><br/><% } %>
                                <%= address.city %>, <%= address.state %>, <%= address.country %><br/>
                                <%= address.postalCode %><br/>
                              </address>
                              <p>Phone: <%= address.phoneNumber %></p>
                              <div class="d-flex justify-content-between">
                                <button style="background-color: #007bff;border-radius: 6px;border: none;"><a href="/editAddress?id=<%= address._id %>" class="btn-small">Edit</a></button>
                                  <!-- <button style="background-color: #ec0f0f;border-radius: 6px;border: none;"> <a href="/deleteAddress?id=<%= address._id %>" class="btn-small" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a></button> -->
                                  <button style="background-color: #ec0f0f;border-radius: 6px;border: none;" 
                                  onclick="confirmDelete('<%= address._id %>')">
                            <span class="btn-small">Delete</span>
                          </button>
                          
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } else { %>
                      <div class="col-lg-6">
                        <div class="card mb-3">
                          <div class="card-header">
                            <h5 class="mb-0">No Address Found</h5>
                          </div>
                          <div class="card-body">
                            <p>No address available</p>
                          </div>
                        </div>
                      </div>
                    <% } %>
                  </div>
                  <div>
                    <a href="/addAddress">
                      <button class="btn btn-primary w-70">Add Address</button>
                    </a>
                  </div>
                </div>

                
              
             <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
              <div class="card1">
                  <div class="card-heade">
                      <h5 class="mb-0">Your Orders</h5>
                  </div>
                  <div class="card-bod">
                      <div class="table-responsive">
                          <table class="table">
                              <thead>
                                  <tr>
                                    <th>product</th>
                                      <th>Order ID</th>
                                      <th>Order Date</th>
                                      <th>Pay Status</th> 
                                      <th>Status</th>
                                      <th>Total Amount</th>
                                      <th>Actions</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <% if (userOrders.length > 0) { %>
                                      <% userOrders.forEach(order => { %>
                                          <tr>
                                            
                                            <td>
                                              <div class="d-flex align-items-center">
                                                <% if (order.items.length > 0) { %>
                                                  <% let item = order.items[0]; %>
                                                  <% if (item.productId.productImage.length > 0) { %>
                                                    <img src="/uploads/re-image/<%= item.productId.productImage[0] %>" 
                                                         alt="Product Image" width="50" height="50" class="me-2">
                                                  <% } else { %>
                                                    <span>No Image Available</span>
                                                  <% } %>
                                            
                                                  <div>
                                                    <strong><%= item.productId.productName %></strong> <br>
                                                    <small>Size: <%= item.productId.size ? item.productId.size.join(', ') : "N/A" %></small> <br>
                                                    <small>Color: <%= item.productId.color ? item.productId.color.join(', ') : "N/A" %></small>
                                                  </div>
                                                <% } %>
                                              </div>
                                            </td>
                                            
                                            
                                            
                                            
                                            
                                              <td><%= order.orderId %></td>
                                              <td>
                                                  <%= new Date(order.createdAt).toLocaleDateString("en-IN", { day: 'numeric', month: 'long', year: 'numeric' }) %>
                                              </td>
                                              
                                              <td style="color: <%= order.status === 'Delivered' || order.paymentStatus === 'Paid' ? 'green' : 'red' %>">
                                                  <%= order.status === 'Delivered' ? 'Paid' : order.paymentStatus %>
                                              </td>
                                              <td>
                                                <span class="<%= order.status === 'Pending' ? 'text-warning' 
                                                            : (order.status === 'Cancelled' || order.status === 'Returned') ? 'text-danger' 
                                                            : (order.status === 'Return Requested') ? 'text-primary' 
                                                            : 'text-success' %>">
                                                    <%= order.status %>
                                                </span>
                                            </td>
                                              <!-- <td>₹<%= order.totalAmount %></td> -->
                                              <td>₹<%= Math.round(order.totalAmount / 10) * 10 %></td>

                                              <td>
                                                  <a style="color: rgb(219, 219, 230);" href="/order-details/<%= order._id %>" class="btn btn-primary btn-sm">View Details</a>
                                                  
                                                  <% if (order.status !== "Delivered" && order.status !== "Cancelled" && order.status !== "Return Requested" && order.status !== "Return accepted" && order.status !== "Return rejected") { %>
                                                    <a href="/cancel-order/<%= order.orderId %>?payment=<%= order.paymentMethod %>" class="btn btn-danger btn-sm">Cancel</a>
                                                <% } %>
                                                <% if (order.status === "Delivered") { %>
                                                    <a href="/return-order/<%= order.orderId %>?payment=<%= order.paymentMethod %>" class="btn btn-warning btn-sm">Return</a>
                                                <% } %>
                                                <% if (order.paymentStatus === "Failed") { %>
                                                  <a href="/retry-payment/<%= order.orderId %>" class="btn btn-success btn-sm">Continue Payment</a>
                                              <% } %>
                                                
                                              </td>
                                          </tr>
                                      <% }); %>
                                  <% } else { %>
                                      <tr>
                                          <td colspan="5" class="text-center">No orders found.</td>
                                      </tr>
                                  <% } %>
                                </tbody>
                              </table>
                            </div>
                            
                            
                              <nav>    
                     
                        <ul class="pagination justify-content-center">
                          <% if (hasPrev) { %>
                            <li class="page-item">
                              <a class="page-link"  href="?page=<%= prevPage %>">Previous</a>
                            </li>
                          <% } %>
                      
                          <li class="page-item active">
                            <span class="page-link">Page <%= currentPage %> of <%= totalPages %></span>
                          </li>
                      
                          <% if (hasNext) { %>
                            <li class="page-item">
                              <a class="page-link" href="?page=<%= nextPage %>">Next</a>
                            </li>
                          <% } %>
                        </ul>
                      </nav>
                      
                  </div>
              </div>
          </div>

                <!-- Wallet Status Tab -->
          <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
              <div class="card">
                  <div class="card-header">
                      
                      <h5 class="mb-0">Wallet Balance: ₹<span id="wallet-balance"><%= user.wallet %></span></h5>

                  </div>
                  <div class="card-body contact-from-area">
                      <div class="row">
                          <div class="col-lg-8 mx-auto text-center mt-90">
                               
                                <form id="walletForm">
                                  <div class="form-group">
                                      <label for="walletAmount" class="h4">Enter Amount:</label>
                                      <input type="number" id="walletAmount" class="form-control" min="1" required>
                                  </div>
                                  <button type="button" class="btn btn-success" onclick="addMoney()">Add Money</button>
                              </form>
                         
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Wallet History Tab -->
                <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="wallet-history-tab">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="mb-0">Wallet History</h5>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        

                    <table class="table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Status</th>
                          <th>Description</th>
                          <th>Amount</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (walletHistory.length > 0) { %> 
                          <% walletHistory.forEach(transaction => { %>  
                            <tr>
                              <td><%= new Date(transaction.date).toLocaleDateString() %></td>
                              <td>
                                <% if (transaction.type === "credit") { %>
                                  <span class="text-success">Credited</span>
                                <% } else { %>
                                  <span class="text-danger">Debited</span>
                                <% } %>
                              </td>
                              <td><%= transaction.description %></td>
                              <td>₹<%= transaction.amount %></td>
                            </tr>
                          <% }); %>
                        <% } else { %>
                          <tr>
                            <td colspan="4" class="text-center">No transactions found.</td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>
                    
                    <nav>
                      <ul class="pagination justify-content-center">
                        <% if (walletHasPrev) { %>
                          <li class="page-item">
                            <a class="page-link" style="background-color: #007bff;color: white;" href="?walletPage=<%= walletPrevPage %>">Previous</a>
                          </li>
                        <% } %>
                    
                        <li class="page-item disabled">
                          <span class="page-link">Page <%= walletCurrentPage %> of <%= walletTotalPages %></span>
                        </li>
                    
                        <% if (walletHasNext) { %>
                          <li class="page-item">
                            <a class="page-link" style="background-color: #007bff;color: white;" href="?walletPage=<%= walletNextPage %>">Next</a>
                          </li>
                        <% } %>
                      </ul>
                    </nav>
                    
                    
                    
                      
                    </div>
                  </div>
                </div>  </div>

                    
                


                <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">

              <div class="card ">
                 <div class="card-header">
                    <h5>Referral Program</h5>
                 </div>
                 <div class="card-body">
                    <h6>Refer your friends and earn ₹50 per signup!</h6>
            
                    <p>Share this link:</p>
                     <div class="input-group mb-3">
                        <input type="text" id="referralLink" class="form-control" 
                        value="<%= baseUrl %>/signup?ref=<%= user.referralCode %>" readonly>
                        <button class="btn btn-primary" onclick="copyReferralLink()">Copy</button>
                     </div>
            
                    <p><strong>Wallet Balance: ₹<%= user.wallet %></strong></p>
                 </div>
              </div>
              
            </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>




<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Check if there's an active tab saved in localStorage
      let activeTab = localStorage.getItem("activeTab");
      if (activeTab) {
          let tabElement = document.querySelector(`[href="${activeTab}"]`);
          if (tabElement) {
              tabElement.click(); // Activate the saved tab
          }
      }
  
      // Save the active tab when clicked
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
          tab.addEventListener("click", function () {
              localStorage.setItem("activeTab", this.getAttribute("href"));
          });
      });
  });

   function copyReferralLink() {
    var copyText = document.getElementById("referralLink");
    copyText.select();
    document.execCommand("copy");
    alert("Referral link copied!");
    }
    



function addMoney() {
    let walletInput = document.getElementById('walletAmount');

    if (!walletInput) {
        console.error("walletAmount input field not found!");
        return;
    }

    let amount = walletInput.value;

    if (!amount || amount <= 0) {
        swal("Error!", "Please enter a valid amount!", "error");
        return;
    }

    fetch('/wallet/add-money', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update wallet balance
            document.getElementById('wallet-balance').innerText = data.newBalance;
            
            // Clear input field after successful transaction
            walletInput.value = '';

            Swal.fire({
                title: "Success!",
                text: "Money added successfully!",
                icon: "success",
                confirmButtonText: "OK"
            });
        } else {
            Swal.fire({
                title: "Failed!",
                text: "Transaction failed. Please try again!",
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: "Error!",
            text: "Something went wrong!",
            icon: "error",
            confirmButtonText: "OK"
        });
    });
}


function confirmDelete(addressId) {
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!"
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = `/deleteAddress?id=${addressId}`;
      }
    });
  }


  </script>
  
<%- include("../../views/partials/user/footer") %>


